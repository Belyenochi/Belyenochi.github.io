<!DOCTYPE html>
<html>
<head>
  <title>
    趣谈Linux操作系统笔记02（对应06-08） - The Tao of Jason
  </title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
  <link rel="shortcut icon" href="/favicon.ico" />
  

  <link rel="stylesheet" href="/css/utils/clear.css">
  <link rel="stylesheet" href="/css/style.css">

  <link href="https://google-fonts.mirrors.sjtug.sjtu.edu.cn/css2?family=Noto+Sans+SC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
  <link href="https://cdn.bootcss.com/highlight.js/9.15.6/styles/default.min.css" rel="stylesheet">
</head>

<body>
  <div class="title">
  <img class="title_img" src="/images/icon.png"/><br>
  <p id="site_title">&nbspThe Tao of Jason&nbsp</p>
</div>

  <div class="navi">
    <a id="navi_item" href="/#" class="menu-item-link">Home</a>
    <a id="navi_item" href="/tags" class="menu-item-link">Tags</a>
    <a id="navi_item" href="/about" class="menu-item-link">About</a>
    <a id="navi_item" href="/search" class="menu-item-link">Search</a>
    
        <a id="navi_item" href="/friendlink" class="menu-item-link">Friendlink</a>
    
</div>

<hr/>


  <div class="main">
    <link rel="stylesheet" href="/css/post.css">
<post>

  <div class="post_title">
    趣谈Linux操作系统笔记02（对应06-08）
  </div>

  <br/><br/>

  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.2/build/styles/xcode.min.css">
  <script src="/js/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <div id="post_content">
    <h3 id="0-计算机的工作模式"><a href="#0-计算机的工作模式" class="headerlink" title="0 计算机的工作模式"></a>0 计算机的工作模式</h3><h4 id="0-1-硬件图和计算机的逻辑图"><a href="#0-1-硬件图和计算机的逻辑图" class="headerlink" title="0.1 硬件图和计算机的逻辑图"></a>0.1 硬件图和计算机的逻辑图</h4><p><img src="/images/biji_os_02/1.png" alt=""></p>
<h4 id="0-2-cpu的组成"><a href="#0-2-cpu的组成" class="headerlink" title="0.2 cpu的组成"></a>0.2 cpu的组成</h4><ol>
<li>运算单元</li>
<li>数据单元</li>
<li>控制单元<br><img src="/images/biji_os_02/2.png" alt=""></li>
</ol>
<h3 id="1-x86架构"><a href="#1-x86架构" class="headerlink" title="1 x86架构"></a>1 x86架构</h3><h4 id="1-1-历史"><a href="#1-1-历史" class="headerlink" title="1.1 历史"></a>1.1 历史</h4><p>x86泛指一系列由英特尔公司开发处理器的架构，这类处理器最早为1978年面市的“Intel 8086”CPU。<br>该系列较早期的处理器名称是以数字来表示80x86。由于以“86”作为结尾，包括Intel 8086、80186、80286、80386以及80486，因此其架构被称为“x86”。由于数字并不能作为注册商标，因此Intel及其竞争者均在新一代处理器使用可注册的名称，如Pentium。现时英特尔将其称为IA-32，全名为“Intel Architecture, 32-bit”，一般情形下指代32位的架构。</p>
<h4 id="1-2-8086的原理"><a href="#1-2-8086的原理" class="headerlink" title="1.2 8086的原理"></a>1.2 8086的原理</h4><p>8086的cpu包含以下几个部分：</p>
<ul>
<li>数据单元：AX、BX、CX、DX、SP、BP、SI、DI寄存器</li>
<li>控制单元：IP（指令指针寄存器，指向代码段中下一条指令的位置 ）、CS（代码段寄存器（Code Segment Register），通过它可以找到代码在内存中的位置）、DS（数据段的寄存器，通过它可以找到数据在内存中的位置）、SS（栈寄存器）、ES<br><img src="/images/biji_os_02/3.png" alt=""><h4 id="1-3-课堂练习"><a href="#1-3-课堂练习" class="headerlink" title="1.3 课堂练习"></a>1.3 课堂练习</h4>Q: mov, call, ret, jmp, int, add, or, xor, shl, ahr, push, pop, inc, dec, sub, cmp指令含义？<br>A: </li>
<li>mov: 将第二个操作数（源操作数）复制到第一个操作数（目标操作数）。源操作数可以是立即值，通用寄存器，段寄存器或存储器位置; 目标寄存器可以是通用寄存器，段寄存器或存储器位置。两个操作数必须大小相同，可以是字节，字，双字或四字。<font color="red">MOV指令不能用于加载CS寄存器。尝试这样做会导致无效的操作码异常（#UD）。要加载CS寄存器，请使用far JMP，CALL或RET指令。</font></li>
<li>call : 保存将堆栈和分支上的信息链接到使用目标操作数指定的调用过程的过程。目标操作数指定被调用过程中第一条指令的地址。操作数可以是立即值，通用寄存器或存储器位置。</li>
<li>ret : 将程序控制流转移到位于堆栈顶部的返回地址。地址通常由CALL指令放在堆栈上，并返回到CALL指令后面的指令。</li>
<li>jmp : 将程序控制流转移到指令流中的不同点而不记录返回信息。<br>int : 调用中断</li>
<li>add : 添加目标操作数（第一个操作数）和源操作数（第二个操作数），然后将结果存储在目标操作数中。目标操作数可以是寄存器或存储器位置; 源操作数可以是立即数，寄存器或存储器位置。（但是，在一条指令中不能使用两个存储器操作数。）当立即值用作操作数时，它将符号扩展为目标操作数格式的长度。ADD指令执行整数加法。它评估有符号和无符号整数操作数的结果，并设置CF和OF标志，分别表示有符号或无符号结果中的进位（溢出）。SF标志指示签名结果的符号</li>
<li>or : 在目标（第一个）和源（第二个）操作数之间执行按位包含OR运算，并将结果存储在目标操作数位置。源操作数可以是立即数，寄存器或存储器位置; 目标操作数可以是寄存器或存储器位置。（但是，在一条指令中不能使用两个存储器操作数。）如果第一和第二操作数的相应位都为0，则OR指令结果的每一位都设置为0; 否则，每个位都设置为1。</li>
<li>xor : 对目标（第一个）和源（第二个）操作数执行按位异或（XOR）运算，并将结果存储在目标操作数位置。源操作数可以是立即数，寄存器或存储器位置; 目标操作数可以是寄存器或存储器位置。（但是，一条指令不能使用两个存储器操作数。）如果操作数的相应位不同，则结果的每一位都为1; 如果相应的位相同，则每个位为0。</li>
<li>shl : 逻辑左移</li>
<li>shr :逻辑右移</li>
<li>push : 堆栈指针寄存器的值递减，然后将源操作数存储在堆栈顶部</li>
<li>pop:  将值从堆栈顶部加载到使用目标操作数（或显式操作码）指定的位置，然后递增堆栈指针。目标操作数可以是通用寄存器，存储器位置或段寄存器。</li>
<li>inc: 将1添加到目标操作数，同时保留CF标志的状态。目标操作数可以是寄存器或存储器位置。该指令允许更新循环计数器而不会干扰CF标志。（使用立即操作数为1的ADD指令执行更新CF标志的增量操作。）</li>
<li>dec: 从目标操作数中减去1，同时保留CF标志的状态。目标操作数可以是寄存器或存储器位置。该指令允许更新循环计数器而不会干扰CF标志。（要执行更新CF标志的减量操作，请使用立即操作数为1的SUB指令。）</li>
<li>sub : 从第一个操作数（目标操作数）中减去第二个操作数（源操作数），并将结果存储在目标操作数中。目标操作数可以是寄存器或存储器位置; 源操作数可以是立即数，寄存器或内存位置。（但是，在一条指令中不能使用两个存储器操作数。）当立即值用作操作数时，它将符号扩展为目标操作数格式的长度。SUB指令执行整数减法。它评估有符号和无符号整数操作数的结果，并设置OF和CF标志，分别表示有符号或无符号结果中的溢出。SF标志指示签名结果的符号。</li>
<li>cmp: 比较第一个源操作数和第二个源操作数，并根据结果设置EFLAGS寄存器中的状态标志。通过从第一个操作数中减去第二个操作数，然后以与SUB指令相同的方式设置状态标志来执行比较。当立即值用作操作数时，它将符号扩展为第一个操作数的长度。</li>
</ul>
<h3 id="2-Linux内核启动过程（bootloader）"><a href="#2-Linux内核启动过程（bootloader）" class="headerlink" title="2 Linux内核启动过程（bootloader）"></a>2 Linux内核启动过程（bootloader）</h3><h4 id="2-1-启动过程描述"><a href="#2-1-启动过程描述" class="headerlink" title="2.1 启动过程描述"></a>2.1 启动过程描述</h4><p><img src="/images/biji_os_02/4.png" alt=""></p>
<ol>
<li>主板加电，cpu从rom中读取BIOS执行（通过将CS 设置为 0xFFFF，将 IP 设置为 0x0000，跳转到ROM中进行初始化）</li>
<li>BIOS做完计算机硬件自检和初始化后，会选择一个启动设备（例如软盘、硬盘、光盘等）</li>
<li>将 boot.img 从启动设备的主引导扇区(MBR)加载到内存中的 0x7c00（从现在开始进入bootloader，grub2为例）</li>
<li>boot.img加载core.img的第一个扇区diskboot.img（diskboot.img复杂加载core.img的其余模块）</li>
<li>diskboot.img通过启用分段和分页将系统从实模式切换到保护模式增大以寻址空间（为了解压缩lzma_decompress.img）<br><img src="/images/biji_os_02/5.png" alt=""></li>
<li>解压缩kernel.img,跳转到kernel.img开始执行</li>
<li>grub load config解析操作系统配置文件（grub.conf），经过一系列的系统配置初始化函数，最后调用grub_command_execute启动内核</li>
</ol>
<h4 id="2-2-启动过程小结图"><a href="#2-2-启动过程小结图" class="headerlink" title="2.2 启动过程小结图"></a>2.2 <font color="red">启动过程小结图</font></h4><p><img src="/images/biji_os_02/6.png" alt=""><br><img src="/images/biji_os_02/7.png" alt=""><br><img src="/images/biji_os_02/8.png" alt=""></p>
<h3 id="3-内核初始化"><a href="#3-内核初始化" class="headerlink" title="3 内核初始化"></a>3 内核初始化</h3><h4 id="3-1-内核初始化流程"><a href="#3-1-内核初始化流程" class="headerlink" title="3.1 内核初始化流程"></a>3.1 内核初始化流程</h4><p><img src="/images/biji_os_02/9.png" alt=""></p>
<ol>
<li>调用内核初始化函数start_kernel()</li>
<li>初始化进程列表，创建0号进程，这是唯一一个没有通过 fork 或者 kernel_thread 产生的进程，是进程列表的第一个</li>
<li>调用trap_init()初始化中断门</li>
<li>调用mm_init()初始化内存管理模块</li>
<li>调用sched_init()初始化调度模块</li>
<li>调用vfs_caches_init()初始化基于内存的文件系统rootfs</li>
<li>调用rest_init()来做其他方面的初始化<h4 id="3-2-系统调用流程"><a href="#3-2-系统调用流程" class="headerlink" title="3.2 系统调用流程"></a>3.2 系统调用流程</h4><img src="/images/biji_os_02/10.png" alt=""></li>
</ol>
<h4 id="3-3-rest-init"><a href="#3-3-rest-init" class="headerlink" title="3.3 rest_init()"></a>3.3 rest_init()</h4><ul>
<li>调用kernel_thread(kernel_init, NULL, CLONE_FS)创建第1号进程（用户态所有进程的祖先）</li>
<li>调用kernel_thread(kernel_init, NULL, CLONE_FS|CLONE_FILES)创建2号进程（用户态所有进程的祖先）</li>
</ul>
<font color="red">这里的函数 kthreadd，负责所有内核态的线程的调度和管理，是内核态所有线程运行的祖先。</font>

<h4 id="3-4-小结流程"><a href="#3-4-小结流程" class="headerlink" title="3.4 小结流程"></a>3.4 小结流程</h4><p><img src="/images/biji_os_02/11.png" alt=""></p>
<h3 id="4-引用链接"><a href="#4-引用链接" class="headerlink" title="4 引用链接"></a>4 引用链接</h3><p><a href="https://zh.wikipedia.org/wiki/X86" title="x86" target="_blank" rel="noopener">x86</a><br><a href="https://www.felixcloutier.com/x86/" title="x86 and amd64 instruction reference" target="_blank" rel="noopener">x86 and amd64 instruction reference</a></p>

  </div>

  <br/>

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">This post has been read：<span id="busuanzi_value_page_pv"></span>times</span>
  
  <br/><br/>


  

  <div class="copyright" >

    <a class="license-image" rel="license" href="http://creativecommons.org/licenses/by
-nc
-sa
/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by
-nc
-sa
/4.0/80x15.png" />
    </a>

      <p>本作品采用
      <a class="license-word-hyper" rel="license" href="http://creativecommons.org/licenses/by
-nc
-sa
/4.0/">
        知识共享署名
-非商业性使用
-相同方式共享
4.0 国际许可协议</a>
      进行许可。</p>
  </div>


  <div id="top">
    <a href="#">▲</a>
    <a href="#footer">▼</a>
</div>

  
  <script defer src="https://commento.pcrab.xyz/js/commento.js"></script>
<div id="commento"></div>
<noscript>Please enable JavaScript to load the comments.</noscript>


</post>

  </div>

  <foot id="footer">
  <hr class="boldline"/>
  <br>

  <p class="center font">
    
      <a href="https://github.com/pcrab">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
   <path class="icon_path" d="M427.392 853.504a61.44 61.44 0 0 1-1.450667 15.530667 92.586667 92.586667 0 0 1-10.965333 27.605333c-15.061333 25.301333-40.661333 42.154667-73.642667 42.154667-77.653333 0-108.117333-38.101333-146.261333-133.504C169.216 740.693333 157.013333 725.461333 128 725.461333v-85.333333c77.653333 0 108.117333 38.101333 146.261333 133.504 25.856 64.597333 38.058667 79.786667 67.072 79.786667 0-12.373333-0.170667-23.296-0.512-38.144-0.853333-34.816-0.938667-41.941333 0.554667-51.2 0.64-20.352 5.888-34.773333 16.384-49.066667-95.232-20.736-159.445333-63.573333-196.309333-132.992l-13.824-32.426667C134.186667 510.848 128 467.072 128 416.426667c0-58.24 17.749333-110.336 50.944-153.856-10.368-41.386667-8.96-91.989333 13.909333-149.077334l7.466667-18.688 19.2-6.101333c2.56-0.853333 5.632-1.578667 9.301333-2.133333 37.290667-5.888 90.325333 8.106667 159.701334 52.48a565.930667 565.930667 0 0 1 127.274666-14.208c38.741333 0 77.226667 3.882667 114.048 11.605333 67.456-42.24 119.04-55.509333 155.306667-49.92 3.626667 0.597333 6.741333 1.322667 9.258667 2.133333l19.285333 6.101334 7.466667 18.773333c20.010667 50.218667 23.424 96.469333 16.128 136.96C875.434667 296.32 896 352.597333 896 416.512c0 53.888-3.84 94.378667-14.933333 133.802667l-11.733334 32.170666c-30.677333 69.333333-98.304 112.64-202.538666 133.248 10.837333 15.018667 15.872 30.250667 15.872 52.394667v42.666667l-0.042667 42.666666a13.013333 13.013333 0 0 0 0.341333 2.730667L682.666667 938.794667c-36.352 0-63.36-17.706667-76.672-45.653334a88.277333 88.277333 0 0 1-8.661334-40.277333v-84.736c0-3.584-0.128-3.797333-8.832-12.501333-23.296-23.296-33.834667-40.874667-33.834666-72.832v-38.613334l38.4-3.84c114.346667-11.52 176.512-43.221333 197.12-89.6l9.6-26.325333c7.68-27.562667 10.88-61.098667 10.88-107.946667 0-49.706667-17.365333-90.837333-50.218667-123.648L742.4 274.773333l7.381333-24.448c6.528-21.717333 8.106667-47.402667 1.152-76.714666a158.634667 158.634667 0 0 0-3.584 0.938666c-22.826667 6.4-51.370667 20.053333-85.76 43.008l-15.658666 10.453334-18.304-4.522667a467.754667 467.754667 0 0 0-111.829334-13.269333c-42.709333 0-84.906667 5.418667-123.946666 16.042666l-19.029334 5.205334-16.256-11.136c-35.541333-24.32-65.109333-38.826667-88.746666-45.568a158.293333 158.293333 0 0 0-4.864-1.28c-8.234667 33.92-4.992 61.781333 3.413333 82.688l9.984 25.088-18.346667 19.797333C228.693333 332.629333 213.333333 370.986667 213.333333 416.512c0 41.685333 4.864 76.202667 13.824 102.229333l11.178667 26.453334c27.904 52.352 87.168 83.84 192.853333 95.146666l38.144 4.096v38.357334c0 32-10.538667 49.536-33.834666 72.832-8.704 8.704-8.832 8.96-8.832 12.501333l-0.725334 7.893333c-0.512 2.56-0.512 9.258667 0.170667 37.205334 0.298667 12.8 0.469333 22.997333 0.554667 33.621333a33.962667 33.962667 0 0 1 0.725333 6.656z"/>
  </svg>
 </a>

    
    
      <a href="mailto:pcrab@mailbox.org">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M513.78 602.99c-27.28 0.45-53.79-9.09-74.53-26.83l-65.96-56.64c-15.64-13.37-17.48-36.9-4.1-52.54 13.38-15.65 36.9-17.48 52.54-4.1l65.96 56.64c13.68 11.1 33.27 11.1 46.95 0L881.2 253.08l-708.02-2.61c-20.58 0-37.26-16.69-37.26-37.26s16.68-37.26 37.26-37.26H881.2c41.09-2.36 76.32 29.05 78.67 70.14a74.519 74.519 0 0 1-32.46 65.87L580.86 578.38a111.842 111.842 0 0 1-67.08 24.61z m444.57 133.4V438.28c0-20.58-16.68-37.26-37.26-37.26s-37.26 16.69-37.26 37.26V736.4c0 20.58-16.68 37.26-37.26 37.26h-521.7c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h521.7c61.72 0.01 111.78-50.05 111.78-111.79zM362.12 363.75c0-20.58-16.68-37.26-37.26-37.26h-223.6c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h223.59c20.58 0.01 37.27-16.68 37.27-37.26z m0 298.12c0-20.58-16.68-37.26-37.26-37.26h-111.8c-20.58 0-37.26 16.69-37.26 37.26s16.68 37.26 37.26 37.26h111.79c20.58 0 37.27-16.69 37.27-37.26z"/>
  </svg>
</a>

    
    
      <a href="https://t.me/Pcrab">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M834.24 127.872a95.168 95.168 0 0 0-29.856 7.136h-0.128c-9.12 3.616-52.48 21.856-118.4 49.504l-236.224 99.488c-169.504 71.36-336.128 141.632-336.128 141.632l1.984-0.768s-11.488 3.776-23.488 12a64.96 64.96 0 0 0-18.752 18.144c-5.888 8.64-10.624 21.856-8.864 35.52 2.88 23.104 17.856 36.96 28.608 44.608 10.88 7.744 21.248 11.36 21.248 11.36h0.256l156.256 52.64c7.008 22.496 47.616 156 57.376 186.752 5.76 18.368 11.36 29.856 18.368 38.624 3.392 4.48 7.36 8.224 12.128 11.232a35.808 35.808 0 0 0 7.872 3.392l-1.6-0.384c0.48 0.128 0.864 0.512 1.216 0.64 1.28 0.352 2.144 0.48 3.776 0.736 24.736 7.488 44.608-7.872 44.608-7.872l1.12-0.896 92.256-84 154.624 118.624 3.52 1.504c32.224 14.144 64.864 6.272 82.112-7.616 17.376-13.984 24.128-31.872 24.128-31.872l1.12-2.88 119.488-612.128c3.392-15.104 4.256-29.248 0.512-42.976a57.824 57.824 0 0 0-24.992-33.504 59.904 59.904 0 0 0-34.144-8.64z m-3.232 65.6c-0.128 2.016 0.256 1.792-0.64 5.664v0.352l-118.368 605.76c-0.512 0.864-1.376 2.752-3.744 4.64-2.496 1.984-4.48 3.232-14.88-0.896l-189.12-144.992-114.24 104.128 24-153.28 308.992-288c12.736-11.84 8.48-14.336 8.48-14.336 0.896-14.528-19.232-4.256-19.232-4.256l-389.632 241.376-0.128-0.64-186.752-62.88v-0.128l-0.48-0.096a8.64 8.64 0 0 0 0.96-0.384l1.024-0.512 0.992-0.352s166.752-70.272 336.256-141.632c84.864-35.744 170.368-71.744 236.128-99.52 65.76-27.616 114.368-47.872 117.12-48.96 2.624-1.024 1.376-1.024 3.264-1.024z"/>
  </svg>
</a>

    
    
    
    
    
    
    
    
      <a href="/atom.xml">
  <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M122.88 720.213333a128 128 0 0 0 0 180.906667 128 128 0 0 0 180.906667 0 128 128 0 0 0-180.906667-180.906667z m120.746667 120.746667a42.666667 42.666667 0 0 1-60.586667-60.586667 42.666667 42.666667 0 0 1 60.586667 0 42.666667 42.666667 0 0 1 0 60.586667zM213.333333 512a42.666667 42.666667 0 0 0 0 85.333333 213.333333 213.333333 0 0 1 213.333334 213.333334 42.666667 42.666667 0 0 0 85.333333 0 298.666667 298.666667 0 0 0-298.666667-298.666667z m0-170.666667a42.666667 42.666667 0 0 0 0 85.333334 384 384 0 0 1 384 384 42.666667 42.666667 0 0 0 85.333334 0 472.746667 472.746667 0 0 0-137.386667-331.946667A472.746667 472.746667 0 0 0 213.333333 341.333333z m452.693334 16.64A644.693333 644.693333 0 0 0 213.333333 170.666667a42.666667 42.666667 0 0 0 0 85.333333 554.666667 554.666667 0 0 1 554.666667 554.666667 42.666667 42.666667 0 0 0 85.333333 0 644.693333 644.693333 0 0 0-187.306666-452.693334z"/>
  </svg>
</a>

    
  <p>
  <br>
  <p id="hitokoto">:D 获取中...</p>
  <script src="https://v1.hitokoto.cn/?c=a&encode=js&select=%23hitokoto" defer></script>
  <br>
  <p class="center font">
    &copy - <a href="http://www.woaitucao.xyz">Jason</a> -  2020 -  2021 - Powered by <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/pcrab/hexo-theme-quark"> Quark </a> 
  </p>
  <p>
    <a href="https://beian.miit.gov.cn/" target="_blank"></a>
  </p>
  <br/>
</foot>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
